<script>
    // Security Obfuscation for Password & URL
    var _0x5a1e=["\x45\x70\x69\x72\x6f\x63\x40\x31\x32\x33","\x68\x74\x74\x70\x73\x3a\x2f\x2f\x73\x63\x72\x69\x70\x74\x2e\x67\x6f\x6f\x67\x6c\x65\x2e\x63\x6f\x6d\x2f\x6d\x61\x63\x72\x6f\x73\x2f\x73\x2f\x41\x4b\x66\x79\x63\x62\x77\x72\x76\x5f\x51\x52\x57\x41\x34\x50\x6b\x79\x37\x30\x44\x69\x2d\x75\x4a\x79\x7a\x4a\x6a\x72\x4e\x52\x4f\x42\x6b\x71\x45\x43\x34\x55\x6e\x4d\x6e\x66\x53\x33\x47\x42\x63\x5a\x34\x52\x4f\x69\x49\x55\x32\x33\x4f\x30\x56\x54\x36\x75\x72\x36\x68\x77\x4c\x4b\x7a\x49\x4d\x67\x2f\x65\x78\x65\x63"];
    const scriptURL = _0x5a1e[1];
    const passKey = _0x5a1e[0];

    // Idle Timer (5 Minutes)
    let idleTimer;
    const IDLE_LIMIT = 5 * 60 * 1000;
    function resetTimer() { clearTimeout(idleTimer); idleTimer = setTimeout(lockForm, IDLE_LIMIT); }
    window.onload = resetTimer; document.onmousemove = resetTimer; document.onkeydown = resetTimer;

    function lockForm() {
        document.getElementById('passInput').value = "";
        document.getElementById('protectedContent').classList.add('hidden');
        document.getElementById('formButtons').classList.add('hidden');
        document.getElementById('statusLabel').innerText = "Locked";
        document.getElementById('statusLabel').className = "status-tag locked";
        checkValidation();
    }

    // Data Mapping (Sites & Fleets)
    const customerToSites = {
        "TATA STEEL LTD": ["Noamundi Iron Ore Mines", "Khondbond Iron Ore Mines", "TSL West Bokaro Q-SE", "TSL West Bokaro Q-AB", "Joda Iron Ore Mines"],
        "ULTRATECH LTD": ["Rajshree Cements", "Kotputli Cement Works", "Manikgarh Cement Works", "Bela Cement Works", "Awarpur", "Kukurdih Cement Works", "Nathwara Cement Works", "Tadipatri Cement Works", "Rawan Cement Works", "Maihar Cement Works"],
        "AMBUJA CEMENTS LTD": ["Ambuja Darlaghat", "Rabriyawas Cement Works"],
        "LAFARGE": ["Shella Lime Stone Quarry"], "ACC LTD": ["Wadi Cement Works", "Gagal Cement Works", "Kymore Cement Works"],
        "ADANI ENTERPRISES": ["Parsa Kenta Coal Mines"], "NMDC LTD": ["BACHELI", "KIRANDUL"],
        "JSW LTD": ["Nuagaon Iron Ore Mines", "Narayanposhi Iron Ore Mines"], "BIRLA CORPORATION LIMITED": ["Birla Cements Satna"],
        "GANPATI METAL MINING": ["MOIL"]
    };

    const siteToFleet = {
        "Ambuja Darlaghat": ["DarlaT40"], "Wadi Cement Works": ["WadiSRD50", "WadiFRD50"],
        "Rabriyawas Cement Works": ["RbwsD50I", "RbwsD50II"], "Rajshree Cements": ["RjshreeROCL6", "RjshreeFRD50"],
        "Noamundi Iron Ore Mines": ["NoaD65I", "NoaD65II", "NoaD65III", "KTMD65I", "KTMD65II"],
        "Kotputli Cement Works": ["KotputliT40I", "KotputliT40II", "KotputliT40III"], "Manikgarh Cement Works": ["ManikgarhT40"],
        "Khondbond Iron Ore Mines": ["KhondbondD65", "KhondbondL8"], "Shella Lime Stone Quarry": ["LafargeD60", "LafargeT40"],
        "Bela Cement Works": ["BelaFRD50"], "Joda Iron Ore Mines": ["JodaD65I", "JodaD65II"],
        "Narayanposhi Iron Ore Mines": ["NposhiT45I", "NposhiT45II"], "Nuagaon Iron Ore Mines": ["NuagaonT45III"],
        "TSL West Bokaro Q-SE": ["BokaroD65I", "BokaroPRD50", "QSE-DM14", "QSE-DM15"], "TSL West Bokaro Q-AB": ["QAB-DM2K10", "QAB-DM2K11"],
        "Gagal Cement Works": ["GagalFRD50", "GagalT40"], "Kymore Cement Works": ["KymoreT40", "KymoreMGMFRD50", "KymoreBMGFRD50"],
        "Awarpur": ["AwarpurD50I"], "Kukurdih Cement Works": ["KukurdihT45I"], "Nathwara Cement Works": ["NathwaraT40I", "NathwaraT40II"],
        "Tadipatri Cement Works": ["TadipatriT45I"], "Rawan Cement Works": ["RawanD50I"], "Maihar Cement Works": ["MaiharT40I"],
        "Parsa Kenta Coal Mines": ["US091130"], "Birla Cements Satna": ["BirlaT40I"], "BACHELI": ["NMDCT45I", "NMDCT45III", "NMDCT45IV"],
        "KIRANDUL": ["NMDCT45II"], "MOIL": ["GanpatiT40I"]
    };

    function updateSites() {
        const customer = document.getElementById('customerSelect').value;
        const siteSelect = document.getElementById('workSiteSelect');
        const fleetSelect = document.getElementById('fleetSelect');
        siteSelect.innerHTML = '<option value="">-- Select Site --</option>';
        fleetSelect.innerHTML = '<option value="">-- Select Fleet --</option>';
        if (customerToSites[customer]) {
            customerToSites[customer].forEach(s => {
                let opt = document.createElement('option'); opt.value = opt.text = s; siteSelect.add(opt);
            });
        }
    }

    function updateFleet() {
        const site = document.getElementById('workSiteSelect').value;
        const fleetSelect = document.getElementById('fleetSelect');
        fleetSelect.innerHTML = '<option value="">-- Select Fleet --</option>';
        if (siteToFleet[site]) {
            siteToFleet[site].forEach(f => {
                let opt = document.createElement('option'); opt.value = opt.text = f; fleetSelect.add(opt);
            });
        }
    }

    function checkValidation() {
        const fields = [
            document.getElementById('customerSelect').value,
            document.getElementById('valDate').value,
            document.getElementById('valTech').value,
            document.getElementById('workSiteSelect').value,
            document.getElementById('fleetSelect').value,
            document.getElementById('valShift').value,
            document.getElementById('valEngTemp').value,
            document.getElementById('valEngOil').value
        ];
        document.getElementById('submitBtn').disabled = fields.some(v => !v || v.trim()==="");
    }

    document.getElementById('passInput').addEventListener('input', function() {
        const match = this.value === passKey;
        document.getElementById('protectedContent').classList.toggle('hidden', !match);
        document.getElementById('formButtons').classList.toggle('hidden', !match);
        document.getElementById('statusLabel').innerText = match ? "Unlocked" : "Locked";
        document.getElementById('statusLabel').className = "status-tag " + (match ? "unlocked" : "locked");
        checkValidation();
    });

    // Handle Form Submission
    const form = document.getElementById('residencyForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalBtnText = btn.innerText;
        btn.innerText = "Processing..."; btn.disabled = true;

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(() => {
            showSuccess(); // Trigger new success message
            form.reset(); 
            updateSites(); 
            lockForm();
            btn.innerText = originalBtnText;
        })
        .catch(() => { 
            alert("Network Error: Could not reach Google Sheet."); 
            btn.disabled = false; btn.innerText = originalBtnText; 
        });
    });

    // Show Success Message logic
    function showSuccess() {
        const overlay = document.createElement('div');
        overlay.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999;";
        overlay.innerHTML = `
            <div style="background:white;padding:30px;border-radius:10px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.3);">
                <div style="color:#28a745;font-size:50px;margin-bottom:10px;">âœ”</div>
                <h3 style="margin:0;color:#333;">Data Captured Successfully!</h3>
                <p style="color:#666;">The record has been saved to GSheet.</p>
            </div>
        `;
        document.body.appendChild(overlay);
        setTimeout(() => { overlay.remove(); }, 3000); // Remove after 3 seconds
    }
</script>
